name: å®šæœŸæ£€æŸ¥ Actions çŠ¶æ€

on:
    schedule:
        - cron: '0 0 * * *' # æ¯å¤© UTC 0 ç‚¹è¿è¡Œ
        - cron: '0 12 * * *' # æ¯å¤© UTC 12 ç‚¹è¿è¡Œ

jobs:
    check-actions:
        name: æ£€æŸ¥ Actions çŠ¶æ€
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: æ£€æŸ¥æœ€è¿‘çš„å·¥ä½œæµè¿è¡ŒçŠ¶æ€
              uses: actions/github-script@v6
              with:
                  script: |
                      const workflows = ['merge.yml', 'delete-branch.yml'];
                      const results = [];

                      for (const workflow of workflows) {
                          const runs = await github.rest.actions.listWorkflowRuns({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              workflow_id: workflow,
                              per_page: 5,
                              status: 'failure'
                          });
                          
                          if (runs.data.total_count > 0) {
                              results.push({
                                  workflow,
                                  failures: runs.data.workflow_runs.map(run => ({
                                      id: run.id,
                                      created_at: run.created_at,
                                      conclusion: run.conclusion,
                                      html_url: run.html_url
                                  }))
                              });
                          }
                      }

                      if (results.length > 0) {
                          let message = 'âš ï¸ å‘ç°å·¥ä½œæµè¿è¡Œå¤±è´¥ï¼š\n\n';
                          for (const result of results) {
                              message += `### ${result.workflow}\n`;
                              for (const failure of result.failures) {
                                  message += `- [è¿è¡Œ #${failure.id}](${failure.html_url}) åœ¨ ${new Date(failure.created_at).toLocaleString()} å¤±è´¥\n`;
                              }
                              message += '\n';
                          }
                          
                          // åˆ›å»º issue æŠ¥å‘Šé—®é¢˜
                          await github.rest.issues.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: 'ğŸš¨ Actions å·¥ä½œæµæ£€æŸ¥æŠ¥å‘Š',
                              body: message,
                              labels: ['actions-check', 'bug']
                          });
                          
                          // å‘é€é€šçŸ¥åˆ° Slackï¼ˆå¦‚æœé…ç½®äº† webhookï¼‰
                          if (process.env.SLACK_WEBHOOK_URL) {
                              const slackMessage = {
                                  text: message,
                                  blocks: [
                                      {
                                          type: 'header',
                                          text: {
                                              type: 'plain_text',
                                              text: 'ğŸš¨ Actions å·¥ä½œæµæ£€æŸ¥æŠ¥å‘Š'
                                          }
                                      },
                                      {
                                          type: 'section',
                                          text: {
                                              type: 'mrkdwn',
                                              text: message
                                          }
                                      }
                                  ]
                              };
                              
                              await fetch(process.env.SLACK_WEBHOOK_URL, {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json'
                                  },
                                  body: JSON.stringify(slackMessage)
                              });
                          }
                      } else {
                          console.log('âœ… æ‰€æœ‰å·¥ä½œæµè¿è¡Œæ­£å¸¸');
                      }
